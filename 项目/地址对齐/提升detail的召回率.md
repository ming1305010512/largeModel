[TOC]

现在 detail 的典型问题一般是：**边界不稳、被切碎、被吞到 town/district 里、或者被 O 掉**。

------

## 1）先把“detail 的定义”固定住（否则你怎么调都飘）

detail 在地址里通常是：
**街道/镇/乡之后的“剩余细节”**（路/号/栋/单元/室/楼层/门牌/小区/园区/门店/房号等），也包括夹杂的“附近标识”。

建议你在标注规范里加一句硬规则：

> **detail = 行政区划/街镇/村之后，直到姓名/电话之前的全部剩余地址文本。**

这条能直接提升召回（因为很多 detail 被“漏标/少标/边界不一致”导致模型学不会）。

------

## 2）数据侧：让模型“多见 detail 的长尾形态”（最有效）

### ✅ 2.1 过采样 detail 样本（强烈建议）

做一个采样器：**只要样本里出现 detail，就提高采样概率**（比如 2~4 倍）。
NER 里“某类召回低”，过采样通常比调参更快见效。

### ✅ 2.2 专门补一批“detail 难例”

你现在 detail 召回低，常见难例是：

- “XX路XX号XX栋XX单元XX室”
- “XX小区/园区/大厦/写字楼/门店”
- “附加描述：对面/旁边/附近/内/入口处”
- 混合字母数字：`B座A单元503`、`3-2-1502`、`1期2栋3单元`

做法：从你现有 raw 地址里，用正则捞 200~500 条含这些特征的样本补标，性价比极高。

------

## 3）训练侧：让模型“更怕漏 detail”（召回向训练目标倾斜）

### ✅ 3.1 给 detail 类加权（最直接）

在 token-level CrossEntropyLoss 里，对 detail 的 label 权重提高：

- `detail`（B/I/E/S 等）权重设为 2~5
- 其他保持 1

这会明显拉 detail 召回，但可能会轻微降低 detail 精度（可接受的话非常划算）。

### ✅ 3.2 用 Focal Loss（可选）

如果你 O 类占比巨大，Focal Loss 对“少数类召回”更友好。
（不想改太多就先用加权 CE）

------

## 4）解码/后处理：detail “宁可多一点，不要少”（召回神器）

这是你这个任务里**最关键**的一刀，因为 detail 本质上“边界靠规则更稳”。

### ✅ 4.1 “尾巴兜底”规则（强烈建议）

模型预测出 `prov/city/district/town/street` 后：

- 从 **最后一个行政/街镇实体的末尾**开始
- 到 **name/phone 的起点**结束
- 中间这段，如果模型 detail 不完整 → **直接补成 detail**

一句话：

> **detail 用规则兜底：地址主体后剩下的都是 detail。**

这条一般能把 detail 召回直接抬一大截，而且不会伤害整体结构。

### ✅ 4.2 把“门牌类 token”强行吸进 detail

如果 token 命中这些字符/模式：
`路 街 巷 弄 号 栋 幢 单元 室 楼 层 座 院 里 铺 店` 或者连续数字、`-`、`#`
那它附近一段（比如前后 2~5 个 token）优先归入 detail。

------

## 5）输入长度与切分：detail 经常死在“被截断”

你截图里出现过 warning：`no maximum length... Default to no truncation`
这会导致训练/推理不一致，detail 尤其容易出事（因为 detail 往往在后半段）。

### ✅ 5.1 固定 max_length（训练推理一致）

训练时用多少，预测也用多少，例如：

- max_length = 256（地址足够）
- `padding="max_length"`, `truncation=True`, `max_length=256`

### ✅ 5.2 长文本优先保尾（detail 常在后面）

如果文本很长，建议截断策略偏向保留尾部（或滑窗）。
最简单的工程办法：

> 超长时，把“姓名/电话”剥离出来，地址主体截断时尽量保留后半段。

------

## 6）评价方式：你现在 detail 可能是“边界评估太苛刻”

detail 往往边界不完全一致（比如多/少一个“号”）。
你可以同时看两个指标：

- **严格 span-level F1**（现在用的）
- **宽松 IoU / overlap recall**（只要重叠就算命中）

如果宽松 recall 很高但严格 recall 低，那主要是“边界问题”→ 用 4 的规则兜底最有效。

------

# 建议你按这个顺序做（最快看到提升）

1. **加 detail 样本过采样**（2~4倍）
2. **detail 类加权 CE（权重 3 左右）**
3. **后处理：尾巴兜底补 detail**（最猛）
4. 固定 `max_length=256`，训练推理一致

