[TOC]

`repeat_interleave` æ˜¯ PyTorch é‡Œä¸€ä¸ª**éžå¸¸å®¹æ˜“è¢«ä½Žä¼°ã€ä½†ä¸€æ—¦ç†è§£å°±â€œæç„¶å¤§æ‚Ÿâ€çš„å‡½æ•°**ã€‚
æˆ‘æŒ‰ **â€œå®ƒå¹²å˜› â†’ å’Œ repeat çš„åŒºåˆ« â†’ dim è¯­ä¹‰ â†’ é€æ­¥æ‰‹ç®— â†’ å¸¸è§ç”¨æ³• â†’ æ˜“é”™ç‚¹â€** ç»™ä½ å®Œæ•´è®²æ¸…æ¥šã€‚

------

## ä¸€å¥è¯å…ˆç»™ç›´è§‰

> **`repeat_interleave` = â€œæŠŠæŸä¸€ç»´ä¸Šçš„å…ƒç´ ï¼Œä¸€ä¸ªä¸€ä¸ªåœ°å¤åˆ¶å±•å¼€ï¼ˆæ’é˜Ÿå¼é‡å¤ï¼‰â€**

å…³é”®è¯ï¼š

- **é€å…ƒç´ ï¼ˆelement-wiseï¼‰**
- **æŒ‰é¡ºåºæ’å…¥**
- **å¸¸ç”¨äºŽæ ‡ç­¾ã€ç´¢å¼•ã€å¯¹é½é•¿åº¦**

------

## 1ï¸âƒ£ æœ€åŸºç¡€ç”¨æ³•ï¼ˆä¸å¸¦ dimï¼‰

```python
import torch

x = torch.tensor([1, 2, 3])
y = torch.repeat_interleave(x, repeats=2)
print(y)
```

è¾“å‡ºï¼š

```text
tensor([1, 1, 2, 2, 3, 3])
```

è§£é‡Šï¼š

- æ¯ä¸ªå…ƒç´ é‡å¤ `repeats` æ¬¡
- **ä¸æ˜¯æ•´ä½“å¤åˆ¶ï¼Œè€Œæ˜¯â€œå…ƒç´ çº§æ’å…¥â€**

------

## 2ï¸âƒ£ å’Œ `repeat()` çš„æœ¬è´¨åŒºåˆ«ï¼ˆéžå¸¸å…³é”®ï¼‰

### repeatï¼ˆå—çº§å¤åˆ¶ï¼‰

```python
x = torch.tensor([1, 2, 3])
x.repeat(2)
# [1, 2, 3, 1, 2, 3]
```

### repeat_interleaveï¼ˆå…ƒç´ çº§å¤åˆ¶ï¼‰

```python
torch.repeat_interleave(x, 2)
# [1, 1, 2, 2, 3, 3]
```

ðŸ‘‰ **ä¸€å¥è¯åŒºåˆ†ï¼š**

| å‡½æ•°              | å¤åˆ¶å¯¹è±¡       |
| ----------------- | -------------- |
| repeat            | æ•´ä¸ªå¼ é‡ï¼ˆå—ï¼‰ |
| repeat_interleave | æ¯ä¸ªå…ƒç´        |

------

## 3ï¸âƒ£ repeats å¯ä»¥æ˜¯ã€Œæ ‡é‡ã€ä¹Ÿå¯ä»¥æ˜¯ã€Œå‘é‡ã€

### 3.1 repeats æ˜¯æ ‡é‡ï¼ˆç»Ÿä¸€é‡å¤ï¼‰

```python
x = torch.tensor([10, 20, 30])
torch.repeat_interleave(x, 3)
```

ç»“æžœï¼š

```text
[10, 10, 10, 20, 20, 20, 30, 30, 30]
```

------

### 3.2 repeats æ˜¯å¼ é‡ï¼ˆé€å…ƒç´ æŽ§åˆ¶ï¼‰

```python
x = torch.tensor([10, 20, 30])
repeats = torch.tensor([1, 3, 2])

torch.repeat_interleave(x, repeats)
```

ç»“æžœï¼š

```text
[10, 20, 20, 20, 30, 30]
```

è§£é‡Šï¼š

- 10 é‡å¤ 1 æ¬¡
- 20 é‡å¤ 3 æ¬¡
- 30 é‡å¤ 2 æ¬¡

ðŸ“Œ **è¿™ä¸ªèƒ½åŠ›éžå¸¸é‡è¦**ï¼Œå¾ˆå¤šå¯¹é½æ“ä½œé å®ƒã€‚

------

## 4ï¸âƒ£ å¸¦ dim çš„æƒ…å†µï¼ˆäºŒç»´/ä¸‰ç»´é‡Œæœ€å®¹æ˜“è¿·ç³Šï¼‰

### 4.1 dim=0ï¼ˆæŒ‰â€œè¡Œâ€é‡å¤ï¼‰

```python
x = torch.tensor([[1, 2],
                  [3, 4]])

torch.repeat_interleave(x, repeats=2, dim=0)
```

ç»“æžœï¼š

```text
[[1, 2],
 [1, 2],
 [3, 4],
 [3, 4]]
```

ðŸ‘‰ æ¯ä¸€è¡Œï¼Œè¢«â€œçºµå‘æ’é˜Ÿâ€å¤åˆ¶ã€‚

------

### 4.2 dim=1ï¼ˆæŒ‰â€œåˆ—â€é‡å¤ï¼‰

```python
torch.repeat_interleave(x, repeats=2, dim=1)
```

ç»“æžœï¼š

```text
[[1, 1, 2, 2],
 [3, 3, 4, 4]]
```

ðŸ‘‰ æ¯ä¸€åˆ—ï¼Œè¢«â€œæ¨ªå‘æ’é˜Ÿâ€å¤åˆ¶ã€‚

------

## 5ï¸âƒ£ repeats æ˜¯å‘é‡ + dimï¼ˆéžå¸¸å¸¸è§çš„é«˜çº§ç”¨æ³•ï¼‰

```python
x = torch.tensor([[1, 2, 3]])
repeats = torch.tensor([1, 2, 3])

torch.repeat_interleave(x, repeats, dim=1)
```

ç»“æžœï¼š

```text
[[1, 2, 2, 3, 3, 3]]
```

è§£é‡Šï¼š

- ç¬¬ 1 åˆ—é‡å¤ 1 æ¬¡
- ç¬¬ 2 åˆ—é‡å¤ 2 æ¬¡
- ç¬¬ 3 åˆ—é‡å¤ 3 æ¬¡

ðŸ“Œ å¸¸ç”¨äºŽ **token â†’ span / æ ‡ç­¾å±•å¼€ / mask å¯¹é½**ã€‚

------

## 6ï¸âƒ£ ç”¨ã€Œå¹¿æ’­ vs repeat_interleaveã€çš„è§†è§’ç†è§£

ä½ å¯ä»¥æŠŠ `repeat_interleave` ç†è§£æˆï¼š

> **å…ˆæŠŠæŸä¸€ç»´â€œæ‹‰ç›´â€ï¼Œç„¶åŽæŒ‰ repeats è§„åˆ™æ’å…¥å¤šä¸ªæ‹·è´**

è€Œä¸æ˜¯åƒ `repeat` é‚£æ ·åšå—çº§ broadcastã€‚

------

## 7ï¸âƒ£ åœ¨ NLP / æ·±åº¦å­¦ä¹ é‡Œçš„ç»å…¸ç”¨é€”

### âœ… 1. æ ‡ç­¾å¯¹é½ï¼ˆéžå¸¸å¸¸è§ï¼‰

æ¯”å¦‚ï¼š

- å¥çº§æ ‡ç­¾ â†’ token çº§æ ‡ç­¾
- span æ ‡ç­¾ â†’ token æ ‡ç­¾

```python
sent_labels = torch.tensor([0, 1])
token_counts = torch.tensor([3, 5])

token_labels = torch.repeat_interleave(sent_labels, token_counts)
# [0,0,0, 1,1,1,1,1]
```

------

### âœ… 2. beam search / top-k æ‰©å±•

æŠŠ batch æ‰©å±•æˆ `batch_size * beam_size`ï¼š

```python
batch_ids = torch.arange(3)  # [0,1,2]
beam_ids = torch.repeat_interleave(batch_ids, 4)
# [0,0,0,0, 1,1,1,1, 2,2,2,2]
```

------

### âœ… 3. attention / mask å¯¹é½

æŠŠ mask æŒ‰ head æ•°ã€token æ•°å±•å¼€ã€‚

------

## 8ï¸âƒ£ å¸¸è§æ˜“é”™ç‚¹ï¼ˆéžå¸¸é‡è¦ï¼‰

### âŒ 1. repeats é•¿åº¦ä¸åŒ¹é… dim

```python
# x shape = (2,3)
repeats = torch.tensor([1,2])   # âŒ dim=1 éœ€è¦é•¿åº¦=3
```

**è§„åˆ™ï¼š**

> å¦‚æžœ `repeats` æ˜¯å¼ é‡ï¼Œå®ƒçš„é•¿åº¦å¿…é¡»ç­‰äºŽ `x.size(dim)`ã€‚

------

### âŒ 2. æŠŠ repeat å’Œ repeat_interleave ç”¨å

- æƒ³å¤åˆ¶â€œæ ·æœ¬æ•°â€ â†’ ç”¨ `repeat`
- æƒ³å¤åˆ¶â€œæ¯ä¸ªå…ƒç´ â€ â†’ ç”¨ `repeat_interleave`

------

### âŒ 3. å¿˜äº†å®ƒä¼šæ”¹å˜ shapeï¼ˆä¸æ˜¯ viewï¼‰

`repeat_interleave` ä¼šçœŸæ­£ç”Ÿæˆæ–°å¼ é‡ï¼ˆå†…å­˜æ‹·è´ï¼‰ï¼Œä¸æ˜¯ reshapeã€‚

------

## 9ï¸âƒ£ ç”¨ä¸€å¥â€œåˆ¤æ–­ä½ æ˜¯å¦çœŸæ‡‚äº†â€çš„è¯

å¦‚æžœä½ èƒ½ç«‹åˆ»å›žç­”ðŸ‘‡ï¼Œä½ å°±çœŸçš„æ‡‚äº†ï¼š

> **â€œæˆ‘è¦æŠŠæ¯ä¸ªæ ·æœ¬æŒ‰ä¸åŒé•¿åº¦å±•å¼€æˆ token çº§åˆ«ï¼Œæˆ‘è¯¥ç”¨ repeat è¿˜æ˜¯ repeat_interleaveï¼Ÿâ€**
> ç­”æ¡ˆï¼š`repeat_interleave`

