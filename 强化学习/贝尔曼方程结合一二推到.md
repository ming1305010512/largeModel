
$$
\mathbb E_\pi[G_{t+1}\mid S_t=s]
$$

### ① 先对动作 $A_t$ 做全期望

在策略 $\pi$ 下：$P(A_t=a\mid S_t=s)=\pi(a\mid s)$
$$
= \sum_a \pi(a\mid s)\;\mathbb E_\pi[G_{t+1}\mid S_t=s, A_t=a]
$$

### ② 再对下一状态 $S_{t+1}$ 做全期望

在 MDP 下：$P(S_{t+1}=s'\mid S_t=s,A_t=a)=p(s'\mid s,a)$
$$
\mathbb E_\pi[G_{t+1}\mid S_t=s, A_t=a]
= \sum_{s'} p(s'\mid s,a)\;\mathbb E_\pi[G_{t+1}\mid S_t=s, A_t=a, S_{t+1}=s']
$$

### ③ 用马尔可夫性/“状态充分性”去掉过去信息

给定 $S_{t+1}=s'$ 后，未来回报 $G_{t+1}$ 的分布与怎么到达 $s'$ 无关：
$$
\mathbb E_\pi[G_{t+1}\mid S_t=s, A_t=a, S_{t+1}=s']
=
\mathbb E_\pi[G_{t+1}\mid S_{t+1}=s']
$$
于是合并得到：
$$
\boxed{
\mathbb E_\pi[G_{t+1}\mid S_t=s]
=
\sum_a \pi(a\mid s)\sum_{s'} p(s'\mid s,a)\;\mathbb E_\pi[G_{t+1}\mid S_{t+1}=s']
}
$$

### ④ 识别成价值函数（注意是 $s'$！）

因为
$$
V_\pi(s')=\mathbb E_\pi[G_{t+1}\mid S_{t+1}=s']
$$
所以最终：
$$
\boxed{
\mathbb E_\pi[G_{t+1}\mid S_t=s]
=
\sum_a \pi(a\mid s)\sum_{s'} p(s'\mid s,a)\;V_\pi(s')
}
$$

------

## 你纸上“最后两行”的理解也对

你写的这类形式：
$$
\mathbb E[V_\pi(S_{t+1})\mid S_t]
=
\mathbb E\big[\mathbb E[G_{t+1}\mid S_{t+1}] \mid S_t\big]
$$
这就是把 $V_\pi(S_{t+1})$ 看作一个随机变量（因为 $S_{t+1}$ 随机），再对 $S_t$ 条件化，**完全合理**。